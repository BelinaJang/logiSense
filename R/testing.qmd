---
title: "testing"
format: pdf
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(broom)
library(here)
```

```{r}
test_data <- read.csv(here("data", "healthcare-dataset-stroke-data.csv"))

glm_model <- glm(stroke ~ gender + age + hypertension + heart_disease +
                   avg_glucose_level + smoking_status, family = binomial, data = test_data)
summary(glm_model)
```

```{r}
ilr <- function(formula, variable_interest, variable_type, data) {
  
  #formula <- as.formula(paste(outcome, "~", variable_interest, "+", paste(covariates, collapse = "+")))
  
  model <- glm(formula, data = data, family = binomial)
  print(model)
  
  variables_list <- as.list(attr(model$terms, "variables"))[-c(1)]
  print(variables_list)
  
  # outcome variable
  outcome <- as.character(variables_list[[1]])
  print(outcome)
  
  # Extract results for the variable of interest
  result <- tidy(model, conf.int = TRUE, exponentiate = TRUE)
  

  if (variable_type == "continuous") {
    vi_result <- result[result$term == variable_interest, ]
    print(vi_result)
  
    estimate <- vi_result$estimate
    ci_lower <- vi_result$conf.low
    ci_upper <- vi_result$conf.high
    p_value <- vi_result$p.value
  
    interpretation <- paste0(
      "For each one-unit increase in '", variable_interest, "', the odds of '", outcome,
      "' are multiplied by ", round(estimate, 3),
      " p-value: ", p_value,
      " (95% CI: ", round(ci_lower, 3), " - ", round(ci_upper, 3), ")."
    )
  } else if (variable_type == "categorical") {
    data[[variable_interest]] <- factor(data[[variable_interest]])
    
    levels <- levels(data[[variable_interest]])
    
    # first level is the reference level ??
    reference_level <- levels[1]
    #print("reference level", reference_level)
    
    # need a loop for each levels other than reference_level
    # let's use the first comparison level for now
    
    comparison_level <- levels[2]
    #print("comparison_level", comparison_level)
    
    vi_result <- result[result$term == paste0(variable_interest,comparison_level), ]
    print(vi_result)
  
    estimate <- vi_result$estimate
    ci_lower <- vi_result$conf.low
    ci_upper <- vi_result$conf.high
    p_value <- vi_result$p.value
    
    interpretation <- paste0(
      "Compared to the reference level '", reference_level, "' of '", variable_interest, "', the odds of '", 
      outcome, "' for the level '", comparison_level, 
      "' are multiplied by ", round(estimate, 3),
      " p-value: ", round(p_value, 3),
      " (95% CI: ", round(ci_lower, 3), " - ", round(ci_upper, 3), ")."
    )
  } else {
    stop("Variable type must be either 'continuous' or 'categorical.'")
  }
  
  # p-value 
  p_interpretation <- if (p_value < 0.05) {
    "This result is statistically significant at 5% significance level."
  } else {
    "This result is not statistically significant at 5% significance level."
  }
  
  # Combine all the interpretations
  final_output <- paste(interpretation, p_interpretation)
  
  # Return the output
  list(
    Interpretation = final_output,
    Estimate = estimate,
    CI = c(Lower = ci_lower, Upper = ci_upper),
    P_value = p_value
  )
}
```

```{r}
# categorical test
result <- ilr(formula=stroke~gender+age+hypertension+heart_disease+avg_glucose_level+smoking_status,data=test_data, variable_interest="gender", variable_type="categorical")

result

glm(formula=stroke~gender+age+hypertension+heart_disease+avg_glucose_level+smoking_status,data=test_data, family=binomial)

```

```{r}
# continuous test
result <- ilr(stroke~gender+age+hypertension+heart_disease+avg_glucose_level+smoking_status,data=test_data, variable_interest="age", variable_type="continuous")

result
```

```{r}
# double checking!
glm(stroke~gender+age+hypertension+heart_disease+avg_glucose_level+smoking_status,data=test_data, family=binomial)
```



